<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/map.css" />
    <link rel="icon" href="images/icons/favicon.ico" />

    <link rel="manifest" href="/manifest.json" />
    <!-- ios support -->
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_72x72.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_96x96.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_128x128.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_144x144.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_152x152.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_192x192.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_384x384.png" />
    <link rel="apple-touch-icon" href="images/icons/poll_urbain_logo_512x512.png" />
    <meta name="apple-mobile-web-app-status-bar" content="#db4938" />
    <meta name="theme-color" content="#db4938" />

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="js/map.js"></script>
    <script src="js/pin.js"></script>
    <title>Interactive Map</title>
</head>

<body>
    <main>
        <!--resize the next div-->
        <div id="map-container">
            <h1>Poll Urbain</h1>
            <div id="map"></div>
        </div>
        <div id="camera-button">
            <!--button to add camera-->
            <label for="file-input">
                <img id="camera-pic" src="images/pics/camera-icon.png" />
            </label>
            <input id="file-input" type="file" name="image" accept="image/*" capture="environment">
        </div>
    </main>

    <script>
        var Sites;

        /****************************
        *Handle Button Click 
        ***************************/
        function onButtonClick() {
            var dropdownValue = document.getElementById('dropdown').value;
            alert("Button clicked! Dropdown selected value: " + dropdownValue);
        }

        var map = L.map('map').setView([49.183333, -0.350], 17); // Updated coordinates
        var marker = []

        window.onload = async function () {
            try {
                Sites = await readSitesFromJSON("projects");
                addPins(Sites);
            } catch (error) {
                console.error("Error loading sites:", error);
            }
        };

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", function () {
                navigator.serviceWorker
                    .register("js/serviceWorker.js")
                    .then(res => console.log("service worker registered"))
                    .catch(err => console.log("service worker not registered", err))
            })
        }

        const isMobile = navigator.userAgent.match(/(iPad)|(iPhone)|(iPod)|(android)|(webOS)/i);

        function setMap(latitude, longitude) {
            map = map.setView([latitude, longitude], 17);
        }

        if (isMobile) {
            document.getElementById('map').style.height = "60vh";
            var script = document.createElement('script');
            script.src = 'js/position.js';
            document.head.appendChild(script);
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    setMap(position.coords.latitude, position.coords.longitude);
                }, error => {
                    alert("Need permission to use your location in order to use your camera");
                });
            }
            else {
                // If not mobile, hide the camera button
                document.getElementById('camera-button').style.display = 'none';
                document.getElementById('map').style.height = "80vh";
                alert("Geolocation services are not supported by your browser.\n\
                    You can not use the camera on this app")
            }
        }

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    </script>

</body>

</html>