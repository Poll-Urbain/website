<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="map.css" />
    <title>Interactive Map</title>
    <style>
        #map-container {
            text-align: center;
        }

        #map {
            height: 600px;
            /* Increased height */
            width: 70%;
            /* Reduced width */
            margin: 20px auto;
        }

        .popup-content {
            max-height: 300px;
            /* Set your desired maximum height */
            overflow-y: auto;
            /* Enable vertical scroll if content exceeds the maximum height */
            text-align: center;

        }

        img {
            max-width: 200px;
            max-height: 170px;
            width: 90%;
            /* Set the desired width */
            height: auto;
            /* Automatically calculate the height to maintain aspect ratio */
        }
    </style>
    <script src="http://127.0.0.1:5500/map.js" type="text/javascript"> // To change with server address </script>
</head>

<body>
    <div id="map-container">
        <h1>Poll Urbain</h1>
        <div id="map"></div>
        <div id="spot-info"></div>
        <input type="text" id="address-input" placeholder="Enter address">
        <button onclick="geocodeAddressFromTextField()">Show Coordinates</button>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        function loadRankScript() {
            var script = document.createElement('script');
            script.src = 'rank.js';
            document.head.appendChild(script);
        }
        var Sites;
        window.onload = async function () {
            try {
                Sites = await readSitesFromJSON("projects");

            } catch (error) {
                console.error("Error loading sites:", error);
            }
        };

        var map = L.map('map').setView([49.183333, -0.350], 13); // Updated coordinates
        var marker = []
        var i = 0;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);


        function addPins(sites) {
            for (let i = 0; i < sites.length; i++) {
                marker[i] = L.marker([sites[i].coordinates.latitude, sites[i].coordinates.longitude]).addTo(map);
                htmlPopup = "<div class='popup-content'>" +
                    "<b>" + sites[i].name + "</b><br>" +
                    "Caractéristiques (proba):" + sites[i].characteristics + "<br>" +
                    '<div><img src="images/' + sites[i].photo_name + '" alt="' + sites[i].name + 'Image"></div>' + //style="'+'"width:100%; height:auto; maxwidth:100px">' +
                    '<br><button onclick="onButtonClick()">Voter pour</button>' +
                    '<br><label for="dropdown">Choose an option:</label>' +
                    '<select id="dropdown">' +
                    '<option value="Chaleur">Chaleur</option>' +
                    '<option value="Inondation">Inondation</option>' +
                    '<option value="Air">Air</option>' +
                    '</select>' +
                    "</div>";
                marker[i].bindPopup(htmlPopup);
            }
            // Add a zone marker
            var zone = L.marker([49.211029, -0.363451]).addTo(map);

            zone.on('click', function () {
                loadRankScript();
            });

            zone.bindPopup(
                '<div id="image-container" class="image-container">' +
                "<b>Classement des préférences des votes</b><br>" +
                "<br>" +
                '</div>'
            );

            zone.setIcon(L.icon({
                iconUrl: 'images/icons/zone.png',
                iconSize: [30, 50],
                iconAnchor: [25, 50],
                popupAnchor: [0, -50]
            }));
            zone.bindTooltip("Côte de nacre", {
                permanent: true,
                direction: 'right',
                offset: [0, 0]
            });
        }

        window.onload = async function () {
            try {
                Sites = await readSitesFromJSON("projects");
                console.log(Sites[0].name);
                addPins(Sites);
            } catch (error) {
                console.error("Error loading sites:", error);
            }
        };

        // Function to handle button click
        function onButtonClick() {
            var dropdownValue = document.getElementById('dropdown').value;
            alert("Button clicked! Dropdown selected value: " + dropdownValue);
        }

        // Example side panel
        var spotInfo = document.getElementById('spot-info');

        map.on('click', function (e) {
            var clickedLatLng = e.latlng;
            var clickedCoordinates = "Latitude: " + clickedLatLng.lat.toFixed(6) + "<br>Longitude: " + clickedLatLng.lng.toFixed(6);

            // Display clicked coordinates in the side panel
            spotInfo.innerHTML = "<div class='popup-content'><b>Clicked Point</b><br>" + clickedCoordinates + "</div>";
        });
    </script>

</body>

</html>